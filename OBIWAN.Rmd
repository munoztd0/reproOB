---
title: "OBIWAN BEHAVIORAL ANALYSIS"
author: "David Munoz Tord"
date: '2020-12-03'
output:
  pdf_document:
    dev: cairo_pdf
  html_document: default
repro:
  data:
    HED: data/HEDONIC.csv
    INST: data/INST.csv
    PAV: data/PAV.csv
    PIT: data/PIT.csv
    info: data/info.csv
    intern: data/internal.csv
  packages:
  - aaronpeikert/repro@adb5fa569
  - crsh/papaja@devel
  - tinylabels
  - apaTables
  - MBESS
  - afex
  - car
  - ggplot2
  - plyr
  - dplyr
  - tidyr
  - reshape
  - Hmisc
  - Rmisc
  - ggpubr
  - ez
  - gridExtra
  - plotrix
  - parallel
  - emmeans
  - BayesFactor
  - effectsize
  - devtools
  - misty
  - bayestestR
  - lspline
  - kableExtra
  - sjPlot
  - knitr
  - XML
  - rlist
  - janitor
  - optimx
  scripts: R/clean.R
  apt:
    - octave
    - gnuplot
    - libgsl0-dev
---

```{r setup, echo=FALSE, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warnings=FALSE)

library(repro)
# load packages from yaml header
automate_load_packages()
# include external scripts
automate_load_scripts()
# load data
info <- automate_load_data(info, read.csv, stringsAsFactors = T)
intern <- automate_load_data(intern, read.csv, stringsAsFactors = T)
PAV <- automate_load_data(PAV, read.csv, stringsAsFactors = T)
INST <- automate_load_data(INST, read.csv, stringsAsFactors = T)
PIT <- automate_load_data(PIT, read.csv, stringsAsFactors = T)
HED <- automate_load_data(HED, read.csv, stringsAsFactors = T)
```

## Setup

May I suggest running `repro::automate()`? This will create a `Dockerfile` & `Makefile` based on every RMarkdown in this folder and the special yamls in them.
add ENV DEBIAN_FRONTEND=noninteractive
If you are unsure weather or not you have `git` `make` & `docker`.

```{r check, eval=TRUE}
check_git()
check_make()
check_docker()
```

```{r options, echo=FALSE, include=FALSE}
options(scipen = 666, warn=-1, contrasts=c("contr.sum","contr.poly"), mc.cores = parallel::detectCores()) #remove scientific notation # remove warnings #set contrasts to sum !
set.seed(666) #set random seed
control = lmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')) #set "better" lmer optimizer #nolimit # yoloptimizer
emm_options(pbkrtest.limit = 5000) #increase repetitions limit
cl <- parallel::detectCores() #to mulithread
source('R/plots.R', echo=F)# plot specification
source('R/utils.R', echo=F)# useful functions
```

```{r clean, echo=FALSE, include=FALSE}
# this chunk runs R/clean.R (listed in the YAML)
```


## Demographics
### Summary statistics:
```{r demographgics}
df = PAV; df$group = as.factor(revalue(as.factor(df$group), c("control"="Lean", "obese"="Obese")));
AGE = ddply(df,~group,summarise,mean=mean(age),sd=sd(age), min = min(age), max = max(age));
AGE %>%
  kbl(caption ="AGE", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%
  row_spec(0,bold=T)

BMI = ddply(df,~group,summarise,mean=mean(BMI_t1),sd=sd(BMI_t1), min = min(BMI_t1), max = max(BMI_t1)); 
BMI %>%
  kbl(caption ="BMI", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%
  row_spec(0,bold=T)

GENDER = ddply(df, .(id, group), summarise, gender=mean(as.numeric(gender)))  %>%
  group_by(gender, group) %>%
  tally(); GENDER$gender = as.factor(revalue(as.factor(GENDER$gender), c("0"="Men", "1"="Women"))); 
  GENDER %>% kbl(caption ="GENDER") %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%
  row_spec(0,bold=T)

N_group = ddply(df, .(id, group), summarise, group=mean(as.numeric(group)))  %>%
  group_by(group) %>% tally(); N_group$group = as.factor(revalue(as.factor(N_group$group), c("1"="Lean", "2"="Obese"))); 
N_group %>%
  kbl(caption ="Group") %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%
  row_spec(0,bold=T)
```

# Pavlvovian Conditioning Task
## Analysis: Reaction Times
Model Selection we followed Barr et al. (2013) approach to contruct random structure and covariates SEE --> R/MS_PAV_T0.R\
Formula = RT_T ~ condition*group + age + gender + thirsty + hungry + (condition|id) + (1|trialxcondition)\
//The parametric bootstrap involves sampling from the estimated model whose parameters are replaced by its unbiased estimators taken from the sample. For unequal cell frequencies
```{r PAV_RT, echo=FALSE, include=FALSE, cache=TRUE}
# -------------------------------------- RT
formula = 'RT ~ condition*group + age + gender + thirsty + hungry + (condition|id) + (1|trialxcondition)'
### Linear Mixed Models 
# Mixed is just a wrapper for lmer to get p-values from parametric bootstrapping #but set to method "LRT" and remove "args_test" to quick check ##
model = mixed(formula, data = PAV.clean, method = "LRT", control = control, REML = FALSE); 
#model = mixed(formula, data = PAV.clean, method = "PB", control = control, REML = FALSE, args_test = list(nsim = 10, cl=cl)); 

mod <- lmer(formula, data = PAV.clean, control = control, REML = T) # recompute model with REML = T now for further report
ref_grid(model)  #triple check everything is centered at 0
tab_model(mod, show.p = F,show.intercept = F, show.se = T, show.ci = F, title ="", show.re.var = F, digits = 3, dv.labels = "Reaction Times (log)", emph.p = TRUE, file = "tmp/temp1.html")#pred.labels=c("CS+", "Lean", "Interaction (Lean:CS+)")
```
\
```{r PAV_RT_mod}
tables <- list.clean(readHTMLTable("tmp/temp1.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)
tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables2[1:7,1:3] %>% kbl(caption ="Reaction Times (log)" ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T)
tmp =tables2[8:12,1:2]
names(tmp) <- NULL
tmp %>% kbl() %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 
```
\
```{r PAV_RT_BF, cache=TRUE, echo=FALSE, include=FALSE, warning=FALSE}
#calculate exclusion BF01 for each variable
test = extractBF(generalTestBF(RT ~ condition*group + age + gender + thirsty + hungry + id, data= PAV.clean, whichRandom = 'id', neverExclude =  'id')); BF = 1/test[1] #switch to BF10 inclusion
table = nice(model)
table$BF = rev(BF$bf)
```
```{r PAV_RT_res}
table %>% kbl(caption = "Parametric Bootstrap Test method to evaluate significance of fixed effects in mixed-effects models (using MLE fit, nsim = 500) and Bayes Factor from mixed models (see Wagenmakers, 2007)", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T)
```
\
```{r PAV_RT_cont, echo=FALSE, include=FALSE, cache=TRUE}
#Estimated contrast mean and 95% CI\ (one sided test  side = "<")
#p_cond = emmeans(mod, pairwise~ condition, side = "<"); p_cond #for condition (CS+ < CS- left sided!)
#CI_cond = confint(emmeans(mod, pairwise~ condition),level = 0.95, method = c("boot"), nsim = 5000); 
#tab =as_tibble(CI_cond$contrasts); tab$contrast = "CS+ > CS-"

#tab %>% kbl() %>%
  #kable_styling(latex_options = "striped", position = "left", full_width = F) 
```
## Reaction Times by condition
```{r PAV_RT_plot, echo=FALSE, warning=FALSE, cache=TRUE}
# RT
dfR <- summarySEwithin(PAV.means,
                       measurevar = "RT",
                       withinvars = "condition", 
                       idvar = "id")

dfR$cond <- ifelse(dfR$condition == "1", -0.25, 0.25)
PAV.means$cond <- ifelse(PAV.means$condition == "1", -0.25, 0.25)
PAV.means <- PAV.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))

pp <- ggplot(PAV.means, aes(x = cond, y = RT, 
                            fill = condition, color = condition)) +
  geom_line(aes(x = condjit, group = id, y = RT), alpha = .3, size = 0.5, color = 'gray') +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA))+
  geom_point(aes(x = condjit, shape = group), alpha = .3,) +
  geom_crossbar(data = dfR, aes(y = RT, ymin=RT-se, ymax=RT+se), width = 0.2 , alpha = 0.1)+
  ylab('Reaction Times (ms)')+
  xlab('Conditioned stimulus')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(200,800, by = 200)), limits = c(180,875)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Group", labels=c("Lean", "Obese"), values = c(1, 2)) +
  theme_bw()

plt = pp + averaged_theme 
pp + html_theme 
```
```{r PAV_RT_saveFIG, include=FALSE}
cairo_pdf('figures/Figure_PavlovianRT.pdf')
print(plt)
dev.off()
```
## Analysis: Pleasantness Ratings (Pavlovian Cue)
Using ANOVA here because no hierarchical structure\
Formula = liking ~ condition*group + Error (id/condition)\
```{r PAV_Lik, cache=TRUE}
# -------------------------------------- Liking
anova.liking <- aov_car(formula = liking ~ condition*group + Error (id/condition), data = PAV.clean, anova_table = list(correction = "GG", es = "pes"), fun_aggregate = mean); 
``` 

```{r, cache=TRUE, include=FALSE}
#Partial Eta-Squared with 90% CI \
pes_lik = pes_ci(liking ~ condition*group + Error (id/condition), PAV.means); 
#pes_lik %>%
  #kbl() %>%
  #kable_styling(latex_options = "striped", position = "left", full_width = F) 
```
\
Bayes factor\
```{r, cache=TRUE}
liking.BF <- anovaBF(liking ~ condition*group + id, data = PAV.clean, 
                     whichRandom = "id", iterations = 5000); 
BF = as_tibble(liking.BF)[,1:2]

table = nice(anova.liking); table = table[c(2,1,3),]
table$BF =  signif(as.matrix(BF[-c(3),1]),3)
table %>% kbl(caption = "Pleasantness Rating", digits = 1) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T)
```

## Pleasantness Ratings by condition (Pavlvovian Cue)
```{r PAV_LIK_plot, echo=FALSE, warning=FALSE, cache=TRUE}
dfL <- summarySEwithin(PAV.means,
                       measurevar = "liking",
                       withinvars = "condition", 
                       idvar = "id")

dfL$cond <- ifelse(dfL$condition == "1", -0.25, 0.25)

# Liking
pp <- ggplot(PAV.means, aes(x = cond, y = liking, 
                            fill = condition, color = condition)) +
  geom_line(aes(x = condjit, group = id, y = liking), alpha = .3, size = 0.5, color = 'gray' ) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA)) +
  geom_point(aes(x = condjit, shape = group), alpha = .3) +
  geom_crossbar(data = dfL, aes(y = liking, ymin=liking-se, ymax=liking+se), width = 0.2 , alpha = 0.1)+
  ylab('Liking Ratings')+
  xlab('Conditioned stimulus')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 25)), limits = c(-0.05,100.5)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Group", labels=c("Lean", "Obese"), values = c(1, 2)) +
  theme_bw()


pp + html_theme 
plt = pp + averaged_theme 
```
```{r, include=FALSE}
cairo_pdf('figures/Figure_PavlovianLiking.pdf')
print(plt)
dev.off()
```

# Instrumental Conditioning Task
```{r INST_prepro, echo=FALSE, warning=FALSE, cache=FALSE}
#defne factors
fac <- c("id", "gender", "group")
INST[fac] <- lapply(INST[fac], factor)
#revalue all catego
INST$group = as.factor(revalue(INST$group, c(control="-1", obese="1"))) #change value of group

```
## Analysis: Number of Grips
Model selection we followed Barr et al. (2013) approach to contruct random structure and covariates SEE --> R/MS_INST.R\
Formula = grips ~ trial*group + thirsty + hungry  + (1 | id)\
Model Comparison between linear, quadratic, cubic and spline(5) \
```{r INST, echo=FALSE, include=FALSE, cache=TRUE}
# -------------------------------------- STATS -----------------------------------------------------
# stat -  different fit
formu = '*group + (1 |id)'
## LINEAR FIT  
linmod <- lmer(paste('grips~trial', formu),data=INST, control = control, REML = FALSE)
## POLYNOMIAL FIT  
quadmod <- lmer(paste('grips~trial+I(trial^2)', formu), data=INST, control = control, REML = FALSE)
cubmod <- lmer(paste('grips~trial+I(trial^2)+I(trial^3)', formu),data=INST, control = control, REML = FALSE)
## PIECEWISE REGRESSION WITH SPLINES
splinemod <- lmer(paste('grips ~ lspline(trial, 5)', formu),  data = INST, control = control, REML = FALSE)
```
\
```{r cache=TRUE}
BF_fit = bayesfactor_models(linmod, quadmod, cubmod, splinemod, denominator = linmod) 
  kbl(as_tibble(BF_fit), caption = "Model Fit Comparison", digits = 1) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  %>%  row_spec(0,bold=T)
```

Piecewise Regression with Splines has the best fit\
```{r cache=TRUE,  include=FALSE, message=FALSE}
tab_model(splinemod, show.p = F,show.intercept = F, show.se = T, show.ci = F, title ="", show.re.var = F, digits = 3, dv.labels = "Number of grips", emph.p = TRUE, file = "tmp/temp2.html",  pred.labels=c("trial &#60 5", "trial > 5", "group[1]", "trial &#60 5 * group[1]", "trial > 5 * group[1]"))
```
```{r}
tables <- list.clean(readHTMLTable("tmp/temp2.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% row_to_names(row_number = 1)
tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables2[1:5,1:3] %>% kbl(caption ="Number of grips", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  %>%  row_spec(0,bold=T)

tmp =tables2[6:9,1:2]
names(tmp) <- NULL
tmp %>% kbl() %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 
```
\
```{r, echo=FALSE, include=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
tmp = lspline(INST$trial, 5); INST$ls1 = tmp[,1] ; INST$ls2 = tmp[,2]

model = mixed(grips ~ ls1 + ls1:group + ls2 + ls2:group + group + (1 |id), data = INST, method = "LRT", control = control, REML = FALSE) 
#model = mixed(grips ~ ls1 + ls1:group + ls2 + ls2:group + group + thirsty + hungry + piss + (1 |id), data = INST, method = "PB", control = control, REML = FALSE, args_test = list(nsim = 10000, cl=cl)) 

main = lmer(grips ~ ls1 + ls2 + group + (1 |id), data = INST, control = control, REML = F)
null = lmer(grips ~ ls2 + group + (1 |id), data = INST, control = control, REML = F)
test = anova(main, null, test = 'Chisq')
BF_ls1 = exp((test[1,3] - test[2,3])/2); 

main = lmer(grips ~ ls1 + ls2 + group + (1 |id), data = INST, control = control, REML = F)
null = lmer(grips ~ ls1 + group + (1 |id), data = INST, control = control, REML = F)
test = anova(main, null, test = 'Chisq')
BF_ls2 = exp((test[1,3] - test[2,3])/2); 

main = lmer(grips ~ ls1 + ls2 + group + (1 |id), data = INST, control = control, REML = F)
null = lmer(grips ~ ls1 + ls2  + (1 |id), data = INST, control = control, REML = F)
test = anova(main, null, test = 'Chisq')
BF_group = exp((test[1,3] - test[2,3])/2); 

main = lmer(grips ~ ls1*ls2*group + (1 |id), data = INST, control = control, REML = F)
null = lmer(grips ~ ls1 + ls2 + ls2:group + group +(1 |id), data = INST, control = control, REML = F)
test = anova(main, null, test = 'Chisq')
BF_ls1_group = exp((test[1,3] - test[2,3])/2); 

main = lmer(grips ~ ls1*ls2*group  + (1 |id), data = INST, control = control, REML = F)
null = lmer(grips ~ ls1 + ls2 + ls1:group + group + (1 |id), data = INST, control = control, REML = F)
test = anova(main, null, test = 'Chisq')
BF_ls2_group = exp((test[1,3] - test[2,3])/2); 

table = nice(model)
table$BF = BF_ls1
table$BF[2] = BF_ls2
table$BF[3] = BF_group
table$BF[4] = BF_ls1_group
table$BF[5] = BF_ls2_group
table$BF = signif(table$BF, 3)
table$Effect = c("trial < 5" ,"trial > 5","group","trial < 5 * group","trial > 5* group")
```
```{r}
table %>% kbl(caption ="Parametric Bootstrap Test method to evaluate significance of fixed effects in mixed-effects models (using MLE fit, nsim = 500) and Bayes Factor from mixed models (see Wagenmakers, 2007)") %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T)
```

## Number of Grips over time
```{r INST_plot, echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# get the averaged dataset
INST.means <- aggregate(INST$grips, by = list(INST$id, INST$trial, INST$group), FUN='mean') # extract means
colnames(INST.means) <- c('id','trial','group', 'grips')

#over time
dfTRIAL <- summarySEwithin(INST.means,
                           measurevar = "grips",
                           withinvars = "trial",
                           idvar = "id")

dfTRIAL$trial       <- as.numeric(dfTRIAL$trial)

dfTRIALg <- summarySEwithin(INST.means,
                           measurevar = "grips",
                           withinvars = "trial",
                           betweenvars = "group",
                           idvar = "id")

dfTRIALg$trial       <- as.numeric(dfTRIALg$trial)

dfTRIAL$x = dfTRIAL$trial; dfTRIAL$y = dfTRIAL$grips
splinelm <- lm(y ~ lspline(x, 5), data=dfTRIAL)


pp <- ggplot(dfTRIAL, aes(x =trial, y = grips)) +
  geom_point(data = dfTRIALg, aes(shape = group), alpha = 0.3, color = 'black') +
  geom_point(data = dfTRIAL, alpha = 0.5, color = pal[4], shape = 18) +
  #geom_line(color = pal[4]) +
  geom_smooth(method="lm", formula=formula(splinelm), color="tomato",fill = pal[4], size=0.7) + #addd this for lsplines
  #geom_ribbon(aes(ymin=grips-se, ymax=grips+se), fill = pal[4], alpha = 0.3)+
  ylab('Number of Grips')+
  xlab('Trial') +
  scale_y_continuous(expand = c(0, 0),  limits = c(10.5,15.05),  breaks=c(seq.int(11,15, by = 1))) +
  scale_x_continuous(expand = c(0, 0),  limits = c(0,15.1),  breaks=c(seq.int(1,15, by = 1))) +
  scale_shape_manual(name="Group", labels=c("Lean", "Obese"), values = c(1, 2, 18)) +
  theme_bw()

pp + html_theme + theme(legend.position=c(.9,.88), axis.text.x = element_text(size = 16))
plt = pp + averaged_theme + theme(legend.position=c(.9,.88), axis.text.x = element_text(size = 16))
```
```{r echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_Instrumental_trial.pdf')
print(plt)
dev.off()
```

# Pavlvovian-Instrumental Transfer (PIT) Task
```{r PIT_prepro, echo=FALSE, include=FALSE, cache=FALSE}
# define as factors
fac <- c("id", "trial", "condition", "trialxcondition", "gender", "group")
PIT[fac] <- lapply(PIT[fac], factor)
#remove the baseline (we just use it for fMRI analysis)
PIT.clean =  subset(PIT, condition != 'BL') 
#revalue all catego
PIT.clean$group = as.factor(revalue(PIT.clean$group, c(control="-1", obese="1"))) #change value of group
PIT.clean$condition = as.factor(revalue(PIT.clean$condition, c(CSminus="-1", CSplus="1"))); PIT.clean$condition <- factor(PIT.clean$condition, levels = c("1", "-1"))#change value of condition
#center covariates
```
## Analysis: Mobilized effort (AUC)
Model selection we followed Barr et al. (2013) approach to contruct random structure and covariates SEE --> R/MS_PIT.R\
Formula = AUC ~ condition*group + hungry + hungry:condition  + (condition|id) + (1|trialxcondition)\

```{r PIT, echo=FALSE, include=FALSE, cache=TRUE}
# -------------------------------------- STATS -----------------------------------------------
formula = 'AUC ~ condition*group + hungry + hungry:condition  + (condition|id) + (1|trialxcondition)'

### Linear Mixed Models 
# Mixed is just a wrapper for lmer to get p-values from parametric bootstrapping #but set to method "LRT" and remove "args_test" to quick check ##
model = mixed(formula, data = PIT.clean, method = "LRT", control = control, REML = FALSE)
#model = mixed(formula, data = PIT.clean, method = "PB", control = control, REML = FALSE, args_test = list(nsim = 10000, cl=cl)) 

ref_grid(model)  #triple check everything is centered at 0

mod <- lmer(formula, data = PIT.clean, control = control, REML = T) # recompute model with REML = T now for further analysis

tab_model(mod, show.p = F,show.intercept = F, show.se = T, show.ci = F, title ="", show.re.var = F, digits = 3, dv.labels = "Mobilized effort (AUC)", file = "tmp/temp3.html") #, pred.labels=c("CS+", "Lean", "Interaction (Lean:CS+)")

PIT.means <- aggregate(PIT.clean$AUC, by = list(PIT.clean$id, PIT.clean$condition, PIT.clean$group), FUN='mean') # extract means
colnames(PIT.means) <- c('id','condition', 'group', 'n_grips')
test = aov_car(AUC ~ condition*group  + hungry + thirsty  + gender + age +
  Error(id/condition), PIT.clean, factorize = F, fun_aggregate = mean)
```
\
```{r, echo=FALSE}
tables <- list.clean(readHTMLTable("tmp/temp3.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% row_to_names(row_number = 1)
tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables2[1:5,1:3] %>% kbl(caption ="Mobilized effort (AUC)" ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  %>%  row_spec(0,bold=T)

tmp =tables2[6:10,1:2]
names(tmp) <- NULL
tmp %>% kbl() %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  

main = lmer(AUC ~ condition + group + hungry + hungry:condition  + (condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F)
null = lmer(AUC ~ group + hungry + hungry:condition  + (condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F)
test = anova(main, null, test = 'Chisq')

BF_cond = exp((test[1,2] - test[2,2])/2)

main = lmer(AUC ~ condition + group + hungry + hungry:condition  + (condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F)
null = lmer(AUC ~ condition + hungry + hungry:condition  + (condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F)
test = anova(main, null, test = 'Chisq')

BF_group = exp((test[1,2] - test[2,2])/2)

main = lmer(formula, data = PIT.clean, control = control, REML = F)
null = lmer(AUC ~ condition+ group + hungry + hungry:condition  + (condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F)
test = anova(main, null, test = 'Chisq')

BF_inter = exp((test[1,2] - test[2,2])/2)

main = lmer(AUC ~ condition* group + thirsty + hungry  + (condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F)
null = lmer(AUC ~ condition*group + thirsty +(condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F) #here is jsut added "thirsty" to make that the two models are fitted with the same number of partcipants, but this doesnt changew anything for hungry
test = anova(main, null, test = 'Chisq')

BF_hungry = exp((test[1,2] - test[2,2])/2)

main = lmer(formula, data = PIT.clean, control = control, REML = F)
null = lmer(AUC ~ condition*group + hungry + (condition|id) + (1|trialxcondition), data = PIT.clean, control = control, REML = F)
test = anova(main, null, test = 'Chisq')

BF_hungry_int = exp((test[1,2] - test[2,2])/2)

table = nice(model)
table$BF = BF_cond
table$BF[2] = BF_group
table$BF[3] = BF_hungry
table$BF[4] = BF_inter
table$BF[5] = BF_hungry_int
```

```{r}
table %>% kbl(caption = "Parametric Bootstrap Test method to evaluate significance of fixed effects in mixed-effects models (using MLE fit, nsim = 500) and Bayes Factor from mixed models (see Wagenmakers, 2007)", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T)
```

\
```{r, echo=FALSE, include=FALSE, cache=TRUE}
#p_cond = emmeans(mod, pairwise~ condition, side = ">"); p_cond #for condition (CS+ > CS- right sided)
#CI_cond = confint(emmeans(mod, pairwise~ condition),level = 0.95, method = c("boot"), nsim = 5000); #CI_cond$contrasts #get CI condition

inter = emmeans(mod, pairwise~ condition|group, adjust = "tukey", side = ">")  #for group X condition (adjusted but still right sided)
CI_inter = confint(emmeans(mod, pairwise~ condition|group),level = 0.95,method = c("boot"),nsim = 5000) ##get CI inter
tmp = as_tibble(inter$contrasts); 
tab =as_tibble(CI_inter$contrasts); tab$contrast = "CS+ > CS-"; tab$group = c("Lean", "Obese"); tab = select(tab, -c('df')); tab$t = tmp$t.ratio; tab$p = tmp$p.value; #tab$df = c(26,61);
```
\
```{r}
tab %>% kbl(caption = "Post-Hoc test (pairwise~ condition|group, adjust = tukey)", digits = 3) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T)
```

## Mobilized effort (AUC) difference (CS+ > CS-) by group
```{r PIT_plot, echo=FALSE, warning=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = FALSE, dev.args = list(png = list(type = "cairo")))
# create bin for each mini block
#PIT.clean$trialxcondition    <- as.numeric(PIT.clean$trialxcondition)
#PIT.clean  <- ddply(PIT.clean, "id", transform, bin = as.numeric(cut2(trialxcondition, g = 5)))

PIT.s <- subset (PIT.clean, condition == '1'| condition == '-1')
PIT.s$trialxcondition <- factor(PIT.s$trialxcondition)
PIT.means <- aggregate(PIT.s$AUC, by = list(PIT.s$id, PIT.s$condition, PIT.s$group), FUN='mean') # extract means
colnames(PIT.means) <- c('id','condition', 'group', 'force')

#PIT.trial <- aggregate(PIT.s$AUC, by = list(PIT.s$id, PIT.s$trialxcondition), FUN='mean') # extract means
#colnames(PIT.trial) <- c('id','trialxcondition','force')

### Plot between contrasts

df_est = emmeans(mod, pairwise~ condition|group) # estimate contrasts means by group from the model 
dfP = data.frame(df_est$contrasts); dfP$force = dfP$estimate #create a dataframe
CSp = subset(PIT.means, condition == '1'); CSm = subset(PIT.means, condition == '-1'); cont.means = CSp
cont.means$force = CSp$force - CSm$force; 

dfP$groupi <- ifelse(dfP$group == "1", -0.25, 0.25)
cont.means$groupi <- ifelse(cont.means$group == "1", -0.25, 0.25)
set.seed(666)
cont.means <- cont.means %>% mutate(groupjit = jitter(as.numeric(groupi), 0.25),
                                    grouping = interaction(id, groupi))


pp <- ggplot(cont.means, aes(x = groupi, y = force, 
                             fill = group, color = group)) +
  geom_hline(yintercept=0, linetype="dashed", size=0.4, alpha=0.8) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = group, color = NA))+
  geom_point(aes(x = groupjit), alpha = .3,) +
  geom_crossbar(data = dfP, aes(y = force, ymin=force-SE, ymax=force+SE), width = 0.2 , alpha = 0.1)+
  #geom_errorbar(data = dfP,aes(group = group, ymin=force-SE, ymax=force+SE),position=position_nudge(x=0.15), size=0.5, width=0.1,  color = "black") + 
  ylab('\u0394 Mobilized effort (CS+ > CS-)')+
  xlab('')+
  scale_fill_manual(values=c("1" = pal[6],"-1"=pal[1]), guide = 'none') +
  scale_color_manual(values=c("1" = pal[6],"-1"=pal[1]), guide = 'none')  +
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(-200,200, by = 50)), limits = c(-200.5,200.5)) +
  scale_x_continuous(labels=c("Obese", "Lean"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  theme_bw() 

plt = pp + averaged_theme 
pp + html_theme 
```
```{r echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_PIT_con.pdf')
print(plt)
dev.off()
```
## Mobilized effort (AUC) over time
```{r PIT_time, echo=FALSE, warning=FALSE, cache=TRUE}
# PLOT OVERTIME
labels <- c("-1" = "Lean", "1" = "Obese")
PIT.p <- summarySEwithin(PIT.clean,
                         measurevar = "AUC",
                         withinvars = c("trialxcondition","condition"),
                         betweenvars = "group",
                         idvar = "id")

PIT.p$trial <- as.numeric(PIT.p$trialxcondition)
PIT.p = select(PIT.p, c('trial', 'N' , 'AUC', 'sd', 'se', 'ci', 'condition', 'group'))


# plot 
pp <- ggplot(PIT.p, aes(x = as.numeric(trial), y = AUC,
                        color = condition, 
                        fill  = condition))+
  geom_line(alpha = .5, size = 1, show.legend = F) +
  geom_ribbon(aes(ymax = AUC + se, ymin = AUC - se),  alpha=0.4) + 
  geom_point() +
  ylab('Mobilized effort (AUC)')+
  xlab('Trial')+
  scale_color_manual(labels = c('-1'= 'CS-', "1" = 'CS+'), name="", 
                     values = c("1"= pal[2], '-1'= pal[1])) +
  scale_fill_manual(labels = c('-1'= 'CS-', "1" = 'CS+'), name="", 
                    values = c("1"= pal[2], '-1'= pal[1])) +
  scale_y_continuous(expand = c(0, 0),  limits = c(50,200),  breaks=c(seq.int(50,200, by = 50))) +
  scale_x_continuous(expand = c(0, 0),  limits = c(0,15),  breaks=c(seq.int(1,15, by = 2))) +
  theme_bw() +
  facet_wrap(~group, labeller=labeller(group = labels))


pp + html_theme + theme(strip.background = element_rect(fill="white"), legend.key.size = unit(0.3, "cm"), axis.text.x = element_text(size = 16))
plt = pp + averaged_theme + theme(strip.background = element_rect(fill="white"), legend.key.size = unit(0.8, "cm"), axis.text.x = element_text(size = 16))
```
```{r echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_PIT_time.pdf')
print(plt)
dev.off()
```
# Hedonic Reactivity Task
```{r HED_prepro, echo=FALSE, include=FALSE, cache=FALSE}
# define as.factors
fac <- c("id", "trial", "condition", "trialxcondition", "gender", "group")
HED[fac] <- lapply(HED[fac], factor)

#revalue all catego
HED$condition = as.factor(revalue(HED$condition, c(MilkShake="1", Empty="-1"))) #change value of condition
HED$condition <- relevel(HED$condition, "1") # Make MilkShake first
HED$group = as.factor(revalue(HED$group, c(obese="1", control="-1"))) #change value of group

# create Intensity and Familiarity diff
bs = ddply(HED, .(id, condition), summarise, int = mean(perceived_intensity, na.rm = TRUE), fam = mean(perceived_familiarity, na.rm = TRUE)) 
Empty = subset(bs, condition == "-1"); Milkshake = subset(bs, condition == "1"); diff = Empty;
diff$int = Milkshake$int - Empty$int; diff$fam = Milkshake$fam - Empty$fam;
HED = merge(x = HED, y = diff[ , c("int", "fam", 'id')], by = "id", all.x=TRUE)

#center covariates
numer <- c("fam", "int")
HED = HED %>% group_by %>% mutate_at(numer, scale)
HED$intensity = HED$int; HED$familiarity = HED$fam
```
## Analysis: Pleasantness Ratings (Taste)
Model selection we followed Barr et al. (2013) approach to contruct random structure and covariates SEE --> R/MS_HED.R\
Formula = Pleasantness ~ condition*group  + hungry + hungry:condition + familiarity + intensity + intensity:condition + (condition |id) + (1|trialxcondition)\

```{r HED, echo=FALSE, include=FALSE, cache=TRUE}
# -------------------------------------- STATS -----------------------------------------------
formula = 'perceived_liking ~ condition*group + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition)'

### Linear Mixed Models 
# Mixed is just a wrapper for lmer to get p-values from parametric bootstrapping #but set to method "LRT" and remove "args_test" to quick check ##
model = mixed(formula, data = HED, method = "LRT", control = control, REML = FALSE); model
#model = mixed(formula, data = HED, method = "PB", control = control, REML = FALSE, args_test = list(nsim = 10000, cl=cl)) 

ref_grid(model)  #triple check everything is centered at 0

mod <- lmer(formula, data = HED, control = control, REML = T) # recompute model with REML = T now for further analysis

tab_model(mod, show.p = F,show.intercept = F, show.se = T, show.ci = F, title ="", show.re.var = F, digits = 3, dv.labels = "Pleasantness Ratings", file = "tmp/temp4.html") #, pred.labels=c("CS+", "Lean", "Interaction (Lean:CS+)")
```
\
```{r, echo=FALSE, warning=FALSE}
tables <- list.clean(readHTMLTable("tmp/temp4.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% row_to_names(row_number = 1)
tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables2[1:7,1:3] %>% kbl(caption ="Mobilized effort (AUC)" ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  %>%  row_spec(0,bold=T)

tmp =tables2[8:12,1:2]
names(tmp) <- NULL
tmp %>% kbl() %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  

main = lmer(perceived_liking ~ condition+group + thirsty + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
null = lmer(perceived_liking ~ group+ thirsty + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
test = anova(main, null, test = 'Chisq')

BF_cond = exp((test[1,3] - test[2,3])/2)


main = lmer(perceived_liking ~ condition+group + thirsty + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
null = lmer(perceived_liking ~ condition+ thirsty + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
test = anova(main, null, test = 'Chisq')

BF_group = exp((test[1,3] - test[2,3])/2)

main = lmer(perceived_liking ~ condition*group + thirsty + hungry  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
null = lmer(perceived_liking ~ condition*group + thirsty  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
test = anova(main, null, test = 'Chisq') # here i added thirsty to make sure the to mdoels are fitted on the same number of responses

BF_hungry = exp((test[1,3] - test[2,3])/2)


main = lmer(perceived_liking ~ condition*group + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
null = lmer(perceived_liking ~ condition*group + hungry+ hungry:condition + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
test = anova(main, null, test = 'Chisq') 

BF_fam = exp((test[1,3] - test[2,3])/2)

main = lmer(perceived_liking ~ condition*group + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
null = lmer(perceived_liking ~ condition*group + hungry + hungry:condition + familiarity +  (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
test = anova(main, null, test = 'Chisq') 

BF_int = exp((test[1,3] - test[2,3])/2)

main = lmer(perceived_liking ~ condition*group  + hungry + hungry:condition  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
null = lmer(perceived_liking ~ condition+group + hungry  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
test = anova(main, null, test = 'Chisq') 

BF_group_inter = exp((test[1,3] - test[2,3])/2)

main = lmer(perceived_liking ~ condition*group + thirsty + hungry + hungry:condition +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
null = lmer(perceived_liking ~ condition*group+ thirsty + hungry  +  familiarity + intensity + (condition |id) + (1|trialxcondition), data = HED, control = control, REML = F)
test = anova(main, null, test = 'Chisq') # same here 

BF_hungry_inter = exp((test[1,3] - test[2,3])/2)


table = nice(model)
table$BF = c(0,0,0,0,0,0,0)
table$BF[1] = BF_cond
table$BF[2] = BF_group
table$BF[3] = BF_hungry
table$BF[4] = BF_fam
table$BF[5] = BF_int
table$BF[6] = BF_group_inter
table$BF[7] = BF_hungry_inter
```

```{r}
table %>% kbl(caption = "Parametric Bootstrap Test method to evaluate significance of fixed effects in mixed-effects models (using MLE fit, nsim = 500) and Bayes Factor from mixed models (see Wagenmakers, 2007)", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T)
```

## Pleasantness Ratings (Taste) by condition
```{r HED_plot, echo=FALSE, warning=FALSE, cache=TRUE}
HED.means <- aggregate(HED$perceived_liking, by = list(HED$id, HED$condition, HED$group), FUN='mean') # extract means
colnames(HED.means) <- c('id','condition','group', 'perceived_liking')


# AVERAGED EFFECT
dfH <- summarySEwithin(HED.means,
                       measurevar = "perceived_liking",
                       withinvars = "condition", 
                       idvar = "id")

dfH$cond <- ifelse(dfH$condition == "1", -0.25, 0.25)
HED.means$cond <- ifelse(HED.means$condition == "1", -0.25, 0.25)
set.seed(666)
HED.means <- HED.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))


pp <- ggplot(HED.means, aes(x = cond, y = perceived_liking, 
                            fill = condition, color = condition)) +
  geom_point(data = dfH, alpha = 0.5) +
  geom_line(aes(x = condjit, group = id, y = perceived_liking), alpha = .3, size = 0.5, color = 'gray') +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA))+
  geom_point(aes(x = condjit, shape = group), alpha = .3,) +
  geom_crossbar(data = dfH, aes(y = perceived_liking, ymin=perceived_liking-se, ymax=perceived_liking+se), width = 0.2 , alpha = 0.1)+
  ylab('Perceived liking') +
  xlab('Taste') +
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 20)), limits = c(-0.5,100.5)) +
  scale_x_continuous(labels=c("Pleasant", "Neutral"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[3], "-1"=pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"=pal[3], "-1"=pal[1]), guide = 'none') +
  scale_shape_manual(name="Group", labels=c("Lean", "Obese"), values = c(1, 2)) +
  theme_bw()

plt <- pp + averaged_theme
pp + html_theme
```
```{r echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_HED.pdf')
print(plt)
dev.off()
```
## Pleasantness Ratings over time
```{r HED_time, echo=FALSE, warning=FALSE, cache=TRUE}

# OVERTIME
HED.t <- summarySEwithin(HED,
                         measurevar = "perceived_liking",
                         withinvars = c("trialxcondition","condition"),
                         idvar = "id")

HED.tg <- summarySEwithin(HED,
                          measurevar = "perceived_liking",
                          withinvars = c("trialxcondition","condition"),
                          betweenvars = 'group',
                          idvar = "id")


# plot 
pp <- ggplot(HED.t, aes(x = as.numeric(trialxcondition), y = perceived_liking,
                        color =condition, fill = condition)) +
  geom_point(data = HED.tg, aes(shape=group), alpha = 0.5) +
  geom_point(data = HED.t) +
  geom_line(alpha = .7, size = 1) +
  geom_ribbon(aes(ymax = perceived_liking + se, ymin = perceived_liking - se),  alpha=0.4) + 
  ylab('Perceived liking')+
  xlab('Trial') +
  scale_shape_manual(name="Group", labels=c("Lean", "Obese"), values = c(1, 2)) +
  scale_color_manual(labels = c('Pleasant', 'Neutral'), name = "",
                     values = c( "1" =pal[3], '-1' =pal[1])) +
  scale_fill_manual(labels = c('Pleasant', 'Neutral'), name = "",
                    values = c( "1" =pal[3], '-1'=pal[1])) +
  scale_y_continuous(expand = c(0, 0),  limits = c(40,100),  breaks=c(seq.int(50,100, by = 10))) +
  scale_x_continuous(expand = c(0, 0),  limits = c(-0.09,20.09),  breaks=c(seq.int(0,20, by = 2))) +
  guides(color=guide_legend(override.aes=list(fill=c(pal[3], pal[1]))))+
  theme_bw()


plt <- pp + averaged_theme + guides(shape = guide_legend(order = 1)) + theme(legend.margin=margin(0,0,0,0), legend.box = "horizontal", legend.key.size = unit(0.4, "cm"), axis.text.x = element_text(size = 16), legend.position = c(0.8, 0.915)) 
pp + html_theme + guides(shape = guide_legend(order = 1)) + theme(legend.margin=margin(0,0,0,0), legend.box = "horizontal", legend.key.size = unit(0.4, "cm"), axis.text.x = element_text(size = 16), legend.position = c(0.8, 0.915)) 

```
```{r echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_HED_time.pdf')
print(plt)
dev.off()
```



